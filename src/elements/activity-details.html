<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-dropdown/iron-dropdown-scroll-manager.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">

<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="../../bower_components/paper-dialog-behavior/paper-dialog-behavior.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">

<link rel="import" href="../../bower_components/neon-animation/neon-animation-runner-behavior.html">

<link rel="import" href="../../bower_components/marked-element/marked-element.html">

<link rel="import" href="../styles/dialog-styles.html">
<link rel="import" href="../styles/shared-styles.html">
<link rel="import" href="../behaviors/utils-behavior.html">
<link rel="import" href="truncate-marked-text.html">


<dom-module id="activity-details">

  <template>

    <firebase-document
      id="activity"
      app-name="{$ firebase.name $}"
      path="/activities/[[activityId]]"
      data="{{activityRaw}}"></firebase-query>

    <style include="shared-styles dialog-styles"></style>

    <paper-scroll-header-panel id="scrollHeaderPanel" condenses="{{app.isPhoneSize}}" no-reveal="{{!app.isPhoneSize}}">
      <paper-toolbar class="tall">
        <a href="/activities">
          <paper-icon-button class="back-button" dialog-dismiss icon="arrow-back"></paper-icon-button>
        </a>
        <div class="middle fallback-image-wrapper" hidden$="{{app.isPhoneSize}}">
          <iron-image class="fallback-image" src="/images/logo-white.svg"
                      alt="{$ title $}"></iron-image>
        </div>
        <div id="title" class="bottom title toolbar-title" hidden$="{{!app.isPhoneSize}}">[[activity.title]] [[activityId]]</div>
      </paper-toolbar>
      <div class="content">
        <div class="metadata-wrapper">
          <div class="main-info">
            <div class="photo" style$="background-image: url('[[activity.photoUrl]]')" hidden$="{{app.isPhoneSize}}"></div>
            <div class="info">
              <h1 class="main-title" hidden$="{{app.isPhoneSize}}">[[activity.title]]</h1>
              <div class="meta highlight"></div>
            </div>
          </div>
        </div>
      </div>
    </paper-scroll-header-panel>

  </template>

  <script>
    (function () {
      'use strict';

      Polymer({

        is: 'activity-details',

        behaviors: [
          Polymer.PaperDialogBehavior,
          Polymer.NeonAnimationRunnerBehavior,
          HOVERBOARD.UtilsBehavior
        ],

        properties: {
          activityRaw: {
            type: Object,
            notify: true,
            value: null
          }
        },

        observers: [
          '_onActivityChanged(app.user,activityRaw)'
        ],

        listeners: {
          'neon-animation-finish': '_onNeonAnimationFinish'
        },

        ready: function () {
          addEventListener('paper-header-transform', function (e) 
          {
            var d = e.detail;
            var m = d.height - d.condensedHeight;
            var transform = 40 * (d.y / m > 1 ? 1 : d.y / m);
            Polymer.Base.translate3d(transform + 'px', 0, 0, this.$.title);
          }.bind(this));
        },

        _onActivityChanged: function()
        {
           if( this.activityRaw && this._isEnabledActivity() )
           {
             this.activity = this.activityRaw;
           }
        },

        _isEnabledActivity: function()
        {
          return(this.activityRaw && (this.app.user || this.activityRaw.public));
        },

        _renderOpened: function () {
          if (this.withBackdrop && !this.app.isPhoneSize) {
            this.backdropElement.open();
          }
          this.playAnimation('entry');
          this.async(function () {
            this.$.scrollHeaderPanel.scroll(1, true);
            this.$.scrollHeaderPanel.notifyResize();
          });
        },

        _renderClosed: function () {
          HOVERBOARD.Util.setMetaThemeColor(this._previousBrowserColor);
          this.backdropElement.close();
          this.playAnimation('exit');
        },

        _onNeonAnimationFinish: function () {
          if (this.opened) {
            Polymer.IronDropdownScrollManager.pushScrollLock(this.$.scrollHeaderPanel);
            this._finishRenderOpened();
          } else {
            Polymer.IronDropdownScrollManager.removeScrollLock(this.$.scrollHeaderPanel);
            this._finishRenderClosed();
          }
        }
      });

    }());
  </script>

</dom-module>
