<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/app-storage/app-network-status-behavior.html">
<link rel="import" href="../../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">

<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">

<link rel="import" href="../../bower_components/paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="../../bower_components/paper-dialog-behavior/paper-dialog-behavior.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">

<link rel="import" href="../../bower_components/neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="../../bower_components/marked-element/marked-element.html">

<link rel="import" href="../../bower_components/polymerfire/firebase-document.html">

<link rel="import" href="../styles/dialog-styles.html">
<link rel="import" href="../behaviors/share-behavior.html">
<link rel="import" href="../behaviors/utils-behavior.html">
<link rel="import" href="../behaviors/my-schedule-behavior.html">
<link rel="import" href="truncate-marked-text.html">

<link rel="import" href="../elements/activity-edit.html">

<dom-module id="activity-details">

  <template>

    <style include="shared-styles dialog-styles">
      a {
        color: var(--default-primary-color);
        text-decoration: none;
      }

      .action-button-wrapper
      {
        margin-top: calc(-28px - var(--content-padding));
        float: right;
        z-index: 1;        
      }

      paper-icon-item {
        cursor: pointer;
      }

      paper-fab {
        --paper-fab-iron-icon: {
          color: inherit;
        };
        transition: background 0.28s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1;
      }

      paper-fab.calendar-check {
        @apply(--shadow-elevation-4dp);
        @apply(--shadow-transition);
        color: #fff;
        background: var(--accent-color);
      }

      paper-fab[disabled]:not(.calendar-check) {
        color: var(--disabled-text-color);
        cursor: default;
      }

      paper-fab[disabled].calendar-check {
        @apply(--shadow-none);
        background: var(--disabled-accent-color);
        cursor: default;
      }

      paper-fab + paper-fab
      {
        margin-left: 5px;
      }

    </style>

    <firebase-document
      id="activity"
      app-name="{$ firebase.name $}"
      path="/activities/[[activityId]]"
      data="{{activityRaw}}">
    </firebase-document>

    <activity-edit id="activityEdit"
      app="{{app}}"
      activity-id="[[activityId]]"
      entry-animation="scale-up-animation"
      exit-animation="fade-out-animation"
      with-backdrop>
    </activity-edit>

    <paper-scroll-header-panel id="scrollHeaderPanel" condenses="{{app.isPhoneSize}}" no-reveal="{{!app.isPhoneSize}}">
      <paper-toolbar class="tall">
        <a href="[[app.page]]">
          <paper-icon-button class="back-button" dialog-dismiss icon="arrow-back"></paper-icon-button>
        </a>
        <div class="middle fallback-image-wrapper" hidden$="{{app.isPhoneSize}}">
          <iron-image class="fallback-image" src="/images/logo-white.svg"
                      alt="{$ title $}"></iron-image>
        </div>
      </paper-toolbar>
      <div class="content">
        <div class="action-button-wrapper" layout horizontal end-justified>
          <template is="dom-if" if="[[_isOwner(app.user,activity)]]">
            <paper-fab
              class$="float-button edit-button"
              icon="edit"
              on-tap="_onEditActivity"
              disabled$="[[!online]]"
            ></paper-fab>
            <paper-fab
              class$="float-button delete-button"
              icon="delete"
              on-tap="_onDeleteActivity"
              disabled$="[[!online]]"
            ></paper-fab>
          </template>
          <template is="dom-if" if="[[!_isOwner(app.user,activity)]]">
            <paper-fab
              class$="float-button sign-button [[_getSubscribedClass(app.user,activity)]]"
              icon="[[_getSubscribedClass(app.user,activity)]]"
              on-tap="_toggleSubscription"
              disabled$="[[!online]]"
            ></paper-fab>
          </template>
        </div>
        <div class="metadata-wrapper">
          <div class="main-info">
            <div class="info">
              <h1 class="main-title">[[activity.data.title]]</h1>
              <div class="meta highlight"></div>
            </div>
          </div>
        </div>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>qqq
        <marked-element markdown="[[activity.data.description]]">
          <div class="markdown-html"></div>
        </marked-element>
      </div>
    </paper-scroll-header-panel>

  </template>

  <script>
    (function () {
      'use strict';

      Polymer({

        is: 'activity-details',

        behaviors: [
          Polymer.PaperDialogBehavior,
          Polymer.NeonAnimationRunnerBehavior,
          Polymer.AppNetworkStatusBehavior,
          HOVERBOARD.UtilsBehavior
        ],

        properties: {
          activityRaw: {
            type: Object,
            notify: true,
            value: null
          },

          activity: {
            type: Object,
            value: 
            {
              data: {},
              participants: {}
            }
          }
        },

        observers: [
          '_onActivityChanged(app.user,activityRaw.*)'
        ],

        listeners: {
          'neon-animation-finish': '_onNeonAnimationFinish'
        },

        _isOwner: function()
        {
          return( this.activity.data && 
            this.app.user &&
            this.activity.data.owner == this.app.user.uid );
        },

        _getSubscribedClass: function()
        {
          return( this._isSubscribed() ? 'calendar-check' : 'calendar-plus' );
        },

        _isSubscribed: function()
        {
          return( this.app.user && 
            this.activity.participants &&
            this.activity.participants[this.app.user.uid] && 
            this.activity.participants[this.app.user.uid].signed );
        },

        _toggleSubscription: function()
        {
          var state = !this._isSubscribed();
          firebase.app("{$ firebase.name $}").database().ref("activities/"+this.activityId+'/participants/'+this.app.user.uid).update(
          {
            signed: state
          }).then(() =>
          {
            HOVERBOARD.Elements.Template.$.toast.showMessage(state ? "{$ addedToSubscription $}" : "{$ removedFromSubscription $}");
          });
        },

        _onEditActivity: function()
        {
          window.requestAnimationFrame(function() 
          {
            this.$.activityEdit.open();
          }.bind(this));
        },

        _onDeleteActivity: function()
        {
          firebase.app("{$ firebase.name $}").database().ref("activities/"+this.activityId).remove().then(() =>
          {
            this.close();
            HOVERBOARD.Elements.Template.$.toast.showMessage("{$ activityWasRemoved $}");
          });
        },

        _onActivityChanged: function()
        {
           if( this.activityRaw && this._isEnabledActivity() )
           {
             this.activity = Object.assign({},this.activityRaw);
           }
        },

        _isEnabledActivity: function()
        {
          return(this.activityRaw && (this.app.user || this.activityRaw.data.public));
        },

        _renderOpened: function () {
          if (this.withBackdrop && !this.app.isPhoneSize) {
            this.backdropElement.open();
          }
          this.playAnimation('entry');
          this.async(function () {
            this.$.scrollHeaderPanel.scroll(1, true);
            this.$.scrollHeaderPanel.notifyResize();
          });
        },

        _renderClosed: function () {
          this.$.activityEdit.close();
          HOVERBOARD.Util.setMetaThemeColor(this._previousBrowserColor);
          this.backdropElement.close();
          this.playAnimation('exit');
        },

        _onNeonAnimationFinish: function (e) {
          if (this.opened) {
            Polymer.IronDropdownScrollManager.pushScrollLock(this.$.scrollHeaderPanel);
//            document.body.style.overflow = 'hidden';
            this._finishRenderOpened();
          } else {
            Polymer.IronDropdownScrollManager.removeScrollLock(this.$.scrollHeaderPanel);
//            document.body.style.overflow = '';
            this._finishRenderClosed();
          }
        }
      });

    }());
  </script>

</dom-module>
